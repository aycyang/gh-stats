<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GitHub Commit Analytics</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f6f8fa;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-section {
      text-align: center;
      padding: 40px 0;
    }
    .controls {
      display: flex;
      gap: 20px;
      align-items: end;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: 600;
      color: #24292f;
    }
    input, select, button {
      padding: 8px 12px;
      border: 1px solid #d1d9e0;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      background: #0969da;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover {
      background: #0550ae;
    }
    button:disabled {
      background: #8c959f;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      text-align: center;
      color: #656d76;
      margin: 20px 0;
    }
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #f6f8fa;
      padding: 16px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #0969da;
    }
    .stat-label {
      font-size: 12px;
      color: #656d76;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .main-chart {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .chart-title {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 600;
      color: #24292f;
    }
    .d3-chart {
      width: 100%;
      height: 500px;
    }
    .axis {
      font-size: 12px;
    }
    .axis text {
      fill: #656d76;
    }
    .axis path,
    .axis line {
      fill: none;
      stroke: #e1e7ef;
      stroke-width: 1;
    }
    .grid line {
      stroke: #f6f8fa;
      stroke-width: 1;
    }
    .grid path {
      stroke-width: 0;
    }
    .area {
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .area:hover {
      opacity: 0.8;
    }
    .language-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .legend-item:hover {
      background: #f6f8fa;
    }
    .legend-item.dimmed {
      opacity: 0.3;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    .d3-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .d3-tooltip.visible {
      opacity: 1;
    }
    .tooltip-header {
      font-weight: 600;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 4px;
    }
    .tooltip-language {
      color: #ffd700;
      font-weight: 500;
    }
    .tooltip-repos {
      margin-top: 8px;
    }
    .tooltip-repo {
      margin: 2px 0;
      padding-left: 8px;
    }
    .error {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      color: #c53030;
      padding: 12px;
      border-radius: 6px;
      margin: 20px 0;
    }
    .hidden {
      display: none;
    }
    .filter-controls {
      background: #f8f9fa;
      border: 1px solid #e1e7ef;
      border-radius: 6px;
      padding: 15px;
      margin: 20px 0;
      transition: all 0.3s ease;
    }
    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .filter-header h4 {
      margin: 0;
      color: #24292f;
      font-size: 14px;
    }
    .filter-toggle {
      background: none;
      border: none;
      font-size: 12px;
      color: #656d76;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .filter-toggle:hover {
      background: #e1e7ef;
    }
    .filter-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .filter-content.expanded {
      max-height: 500px;
    }
    .commit-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e1e7ef;
      border-radius: 4px;
    }
    .commit-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #f6f8fa;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .commit-item:hover {
      background: #f6f8fa;
    }
    .commit-item.excluded {
      background: #fff5f5;
      opacity: 0.7;
    }
    .commit-checkbox {
      margin-right: 10px;
    }
    .commit-details {
      flex: 1;
      min-width: 0;
    }
    .commit-message {
      font-size: 13px;
      font-weight: 500;
      color: #24292f;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .commit-meta {
      font-size: 11px;
      color: #656d76;
    }
    .commit-stats {
      font-size: 11px;
      color: #0969da;
      font-weight: 500;
      margin-left: 10px;
    }
    .language-filter-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid #d1d9e0;
      border-radius: 16px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      user-select: none;
    }
    .language-filter-toggle.enabled {
      background: #0969da;
      color: white;
      border-color: #0969da;
    }
    .language-filter-toggle.disabled {
      background: #f6f8fa;
      color: #656d76;
      border-color: #d1d9e0;
      opacity: 0.7;
    }
    .language-filter-toggle:hover {
      border-color: #0969da;
    }
    .language-filter-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .repository-filter-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid #d1d9e0;
      border-radius: 16px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      user-select: none;
    }
    .repository-filter-toggle.enabled {
      background: #0969da;
      color: white;
      border-color: #0969da;
    }
    .repository-filter-toggle.disabled {
      background: #f6f8fa;
      color: #656d76;
      border-color: #d1d9e0;
      opacity: 0.7;
    }
    .repository-filter-toggle:hover {
      border-color: #0969da;
    }
    .repository-filter-icon {
      width: 10px;
      height: 10px;
      background: #656d76;
      border-radius: 2px;
      border: 1px solid rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸš€ GitHub Commit Analytics</h1>
    <p>Analyze your coding activity across repositories and programming languages</p>
  </div>

  <div class="container login-section" id="loginSection">
    <button id="login">Login with GitHub</button>
    <div style="margin-top: 15px;">
      <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; color: #24292f; cursor: pointer;">
        <input type="checkbox" id="includePrivateRepos" style="cursor: pointer;">
        Include private repositories
      </label>
    </div>
    <p style="margin-top: 15px; color: #656d76; font-size: 12px; text-align: center;">
      We'll analyze your commit history from the selected repositories.<br>
      <strong>Public repos:</strong> Only requires user profile access (read-only).<br>
      <strong>Private repos:</strong> Requires broader permissions due to GitHub's OAuth limitations, but we only read commit data.
    </p>
  </div>

  <div class="container hidden" id="analyticsSection">
    <div class="controls">
      <div class="control-group">
        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" />
      </div>
      <div class="control-group">
        <label for="endDate">End Date</label>
        <input type="date" id="endDate" />
      </div>
      <div class="control-group">
        <label>&nbsp;</label>
        <button id="analyzeButton">Analyze Commits</button>
      </div>
    </div>

    <div class="loading" id="loading">
      <p>ðŸ”„ Analyzing your commit history... This may take a minute.</p>
    </div>

    <div class="error hidden" id="error"></div>

    <div id="results" class="hidden">
      <div class="main-chart">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 class="chart-title" style="margin: 0;">Programming Language Activity Over Time</h2>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="timePeriodChart" style="font-size: 14px; color: #24292f; font-weight: 500;">View:</label>
            <select id="timePeriodChart" style="padding: 6px 8px; border: 1px solid #d1d9e0; border-radius: 4px; font-size: 14px; background: white;">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
            </select>
          </div>
        </div>
        <svg class="d3-chart" id="languageTrendChart"></svg>
        <div class="language-legend" id="languageLegend"></div>
      </div>

      <div class="filter-controls" id="filterControls">
        <div class="filter-header" onclick="toggleFilters()">
          <h4>ðŸ”§ Advanced Filters</h4>
          <button class="filter-toggle" id="filterToggleBtn">Show</button>
        </div>
        <div class="filter-content" id="filterContent">
          <div style="margin-bottom: 20px;">
            <p style="margin: 0 0 10px 0; font-size: 12px; color: #656d76; font-weight: 600;">
              Repository Filters:
            </p>
            <div id="repositoryFilters" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
              <!-- Repository toggles will be populated here -->
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <p style="margin: 0 0 10px 0; font-size: 12px; color: #656d76; font-weight: 600;">
              Language Filters:
            </p>
            <div id="languageFilters" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
              <!-- Language toggles will be populated here -->
            </div>
          </div>
          <div style="margin-bottom: 15px;">
            <p style="margin: 0 0 10px 0; font-size: 12px; color: #656d76; font-weight: 600;">
              Commit Filters:
            </p>
            <p style="margin: 0 0 10px 0; font-size: 12px; color: #656d76;">
              Exclude commits with unusually large changes (e.g., code you didn't write):
            </p>
            <div class="commit-list" id="commitList"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="d3-tooltip" id="d3Tooltip"></div>
  </div>

  <pre id="result" style="display: none;"></pre>

  <script>
    // Environment-based GitHub OAuth app configuration
    function detectEnvironment() {
      const hostname = window.location.hostname;
      const port = window.location.port;

      // Development environment detection
      const isDev = hostname === 'localhost' ||
                   hostname === '127.0.0.1' ||
                   hostname.startsWith('192.168.') ||
                   port === '8888' ||
                   hostname.endsWith('.local');

      return {
        isDevelopment: isDev,
        hostname,
        port,
        origin: window.location.origin
      };
    }

    const env = detectEnvironment();

    // GitHub OAuth Client IDs for different environments
    const CLIENT_IDS = {
      development: "Ov23li9WR5NMQ7MLNDLS",
      production: "Ov23liqzxAZdVana8Zna"
    };

    const clientId = env.isDevelopment ? CLIENT_IDS.development : CLIENT_IDS.production;
    const redirectUri = env.origin;

    // Validation and logging
    if (clientId === "YOUR_DEVELOPMENT_CLIENT_ID") {
      console.warn("âš ï¸ Development client ID not configured! Please replace YOUR_DEVELOPMENT_CLIENT_ID with your new development GitHub OAuth app client ID.");
    }

    console.log(`ðŸŒ Environment: ${env.isDevelopment ? 'Development' : 'Production'}`);
    console.log(`ðŸ”‘ Using client ID: ${clientId}`);
    console.log(`ðŸ”— Redirect URI: ${redirectUri}`);
    console.log(`ðŸ–¥ï¸ Detected: ${env.hostname}:${env.port || '(default)'}`);

    let accessToken = null;
    let userProfile = null;
    let rawCommits = [];
    let excludedCommits = new Set();
    let excludedLanguages = new Set();
    let excludedRepositories = new Set();
    let currentTimePeriod = 'weekly';

    // GitHub's official language colors
    const GITHUB_LANGUAGE_COLORS = {
      'JavaScript': '#f1e05a',
      'TypeScript': '#3178c6',
      'Python': '#3572A5',
      'Java': '#b07219',
      'C': '#555555',
      'C++': '#f34b7d',
      'C#': '#239120',
      'PHP': '#4F5D95',
      'Ruby': '#701516',
      'Go': '#00ADD8',
      'Rust': '#dea584',
      'Swift': '#ffac45',
      'Kotlin': '#A97BFF',
      'Scala': '#c22d40',
      'Clojure': '#db5855',
      'ClojureScript': '#db5855',
      'HTML': '#e34c26',
      'CSS': '#563d7c',
      'SCSS': '#c6538c',
      'Sass': '#a53b70',
      'Less': '#1d365d',
      'Vue': '#4FC08D',
      'Svelte': '#ff3e00',
      'Shell': '#89e051',
      'PowerShell': '#012456',
      'Vim Script': '#199f4b',
      'Lua': '#000080',
      'Perl': '#0298c3',
      'R': '#198CE7',
      'Objective-C': '#438eff',
      'Objective-C++': '#6866fb',
      'Dart': '#00B4AB',
      'Haskell': '#5e5086',
      'Erlang': '#B83998',
      'Elixir': '#6e4a7e',
      'F#': '#b845fc',
      'Visual Basic': '#945db7',
      'Dockerfile': '#384d54',
      'YAML': '#cb171e',
      'JSON': '#292929',
      'XML': '#0060ac',
      'Markdown': '#083fa1',
      'SQL': '#e38c00',
      'TOML': '#9c4221',
      'Unknown': '#cccccc'
    };

    function getLanguageColor(language) {
      return GITHUB_LANGUAGE_COLORS[language] || GITHUB_LANGUAGE_COLORS['Unknown'];
    }

    document.getElementById("login").addEventListener("click", () => {
      // Validate client ID configuration
      if (clientId === "YOUR_DEVELOPMENT_CLIENT_ID") {
        showError("GitHub OAuth app not configured for this environment. Please check the console for details.");
        return;
      }

      const includePrivate = document.getElementById("includePrivateRepos").checked;
      // For public repos: try with minimal 'read:user' scope only (public data should be accessible)
      // For private repos: GitHub requires full 'repo' scope (no read-only option available)
      const scope = includePrivate ? "read:user,repo" : "read:user";

      const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scope}`;

      console.log(`ðŸš€ Initiating OAuth flow with scope: ${scope}`);
      window.location.href = authUrl;
    });

    document.getElementById("analyzeButton").addEventListener("click", async () => {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        showError("Please select both start and end dates");
        return;
      }

      if (new Date(startDate) >= new Date(endDate)) {
        showError("Start date must be before end date");
        return;
      }

      await analyzeCommits(startDate, endDate);
    });

    // Add event listener for time period chart selector
    document.addEventListener("DOMContentLoaded", () => {
      const timePeriodChart = document.getElementById("timePeriodChart");
      if (timePeriodChart) {
        timePeriodChart.addEventListener("change", () => {
          currentTimePeriod = timePeriodChart.value;
          if (rawCommits.length > 0) {
            updateDisplays();
          }
        });
      }
    });

    async function handleAuthCode() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");

      if (code) {
        try {
          const res = await fetch(`/.netlify/functions/get_profile_info?code=${code}&client_id=${clientId}`);
          const data = await res.json();

          if (data.access_token || data.login) {
            // Store the user data and show analytics section
            userProfile = data;
            accessToken = data.access_token || localStorage.getItem('github_access_token');

            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("analyticsSection").classList.remove("hidden");

            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);

            document.getElementById("startDate").value = startDate.toISOString().split('T')[0];
            document.getElementById("endDate").value = endDate.toISOString().split('T')[0];
          }
        } catch (error) {
          showError("Failed to authenticate with GitHub");
        }

        // Clear the code from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    async function analyzeCommits(startDate, endDate) {
      showLoading(true);
      hideError();
      hideResults();

      try {
        const params = new URLSearchParams({
          access_token: accessToken,
          username: userProfile.login,
          start_date: startDate,
          end_date: endDate
        });

        const response = await fetch(`/.netlify/functions/get_commit_stats?${params}`);

        if (!response.ok) {
          // Handle different error types
          if (response.status === 504) {
            throw new Error('Request timed out. Try a shorter date range or switch to weekly view for large time periods.');
          }

          let errorMessage = 'Failed to fetch commit statistics';
          try {
            const data = await response.json();
            errorMessage = data.error || errorMessage;
          } catch (jsonError) {
            // If response isn't JSON (like 504 gateway timeout), use status text
            errorMessage = `${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        displayResults(data);
      } catch (error) {
        showError(error.message);
      } finally {
        showLoading(false);
      }
    }

    function displayResults(data) {
      rawCommits = data.commits;
      currentTimePeriod = document.getElementById("timePeriodChart")?.value || 'weekly';
      excludedCommits.clear(); // Reset exclusions on new data
      excludedLanguages.clear(); // Reset language exclusions on new data
      excludedRepositories.clear(); // Reset repository exclusions on new data

      // Set the chart selector to match current period
      const timePeriodChart = document.getElementById("timePeriodChart");
      if (timePeriodChart) {
        timePeriodChart.value = currentTimePeriod;
      }

      // Process and display data
      updateDisplays();
      populateCommitList();
      showResults();
    }

    function updateDisplays() {
      // Filter out excluded commits and repositories
      const filteredCommits = rawCommits.filter(commit => {
        const repoName = `${commit.repository.owner}/${commit.repository.name}`;
        return !excludedCommits.has(commit.oid) && !excludedRepositories.has(repoName);
      });

      // Aggregate data client-side
      const aggregatedData = aggregateCommitsByTimeAndLanguage(filteredCommits, currentTimePeriod);

      displayLanguageTrendChart(aggregatedData);
      populateLanguageFilters(aggregatedData);
      populateRepositoryFilters();
    }

    function displayLanguageTrendChart(timelineData) {
      if (!timelineData.length) {
        document.getElementById("languageTrendChart").innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#656d76">No data available</text>';
        return;
      }

      // Prepare data for D3 stacked area chart
      const data = timelineData.map(d => ({
        date: new Date(d.date),
        ...Object.fromEntries(
          Object.entries(d.languages).map(([lang, langData]) => [lang, langData.changes])
        )
      }));

      // Get all languages and sort by total usage, excluding filtered languages
      const allLanguages = new Set();
      timelineData.forEach(d => Object.keys(d.languages).forEach(lang => {
        if (!excludedLanguages.has(lang)) {
          allLanguages.add(lang);
        }
      }));

      const languageTotals = Array.from(allLanguages).map(lang => ({
        language: lang,
        total: data.reduce((sum, d) => sum + (d[lang] || 0), 0)
      })).sort((a, b) => b.total - a.total);

      const languages = languageTotals.slice(0, 10).map(d => d.language); // Top 10 languages

      // Set up dimensions
      const margin = { top: 20, right: 120, bottom: 40, left: 60 };
      const width = 1000 - margin.left - margin.right;
      const height = 500 - margin.top - margin.bottom;

      // Clear previous chart
      d3.select("#languageTrendChart").selectAll("*").remove();

      const svg = d3.select("#languageTrendChart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Set up scales
      const xScale = d3.scaleTime()
        .domain(d3.extent(data, d => d.date))
        .range([0, width]);

      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d3.sum(languages, lang => d[lang] || 0))])
        .range([height, 0]);

      // Set up stack
      const stack = d3.stack()
        .keys(languages)
        .value((d, key) => d[key] || 0);

      const stackedData = stack(data);

      // Set up area generator
      const area = d3.area()
        .x(d => xScale(d.data.date))
        .y0(d => yScale(d[0]))
        .y1(d => yScale(d[1]))
        .curve(d3.curveCardinal);

      // Create tooltip
      const tooltip = d3.select("#d3Tooltip");

      // Create tooltip functions
      function showLanguageTooltip(event, d, language) {
        // For area hover, find the closest data point
        const bisect = d3.bisector(d => d.data.date).left;
        const x0 = xScale.invert(d3.pointer(event, g.node())[0]);
        const i = bisect(d, x0, 1);
        const d0 = d[i - 1];
        const d1 = d[i];
        const selectedData = d1 && (x0 - d0.data.date > d1.data.date - x0) ? d1 : d0;

        if (!selectedData) return;

        const date = selectedData.data.date.toLocaleDateString();
        const timeEntry = timelineData.find(t => new Date(t.date).getTime() === selectedData.data.date.getTime());
        const langData = timeEntry ? timeEntry.languages[language] : null;

        if (!langData || langData.changes === 0) return;

        // Position tooltip relative to mouse pointer
        const [mouseX, mouseY] = d3.pointer(event, document.body);

        tooltip.html(`
          <div class="tooltip-header">${date}</div>
          <div style="color: white; font-weight: 600; margin-top: 8px;">${language}</div>
          <div style="margin-top: 4px;">${langData.changes.toLocaleString()} changes</div>
          ${langData.repositories.length > 0 ? `
            <div style="margin-top: 8px;">
              <strong>Repositories:</strong>
              ${langData.repositories.slice(0, 5).map(repo => `
                <div style="font-size: 11px; color: #ccc; margin: 2px 0;">
                  ${repo.name}: ${repo.changes.toLocaleString()}
                </div>
              `).join('')}
              ${langData.repositories.length > 5 ? `<div style="font-size: 11px; color: #ccc;">... and ${langData.repositories.length - 5} more</div>` : ''}
            </div>
          ` : ''}
        `)
        .style("left", (mouseX + 10) + "px")
        .style("top", (mouseY - 10) + "px")
        .classed("visible", true);
      }

      function showAllLanguagesTooltip(event, d) {
        const date = d.date.toLocaleDateString();
        const timeEntry = timelineData.find(t => new Date(t.date).getTime() === d.date.getTime());

        // Get all languages with data for this date
        const languagesWithData = timeEntry ? Object.entries(timeEntry.languages).filter(([lang, data]) => data.changes > 0) : [];
        languagesWithData.sort((a, b) => b[1].changes - a[1].changes);

        // Position tooltip relative to mouse pointer
        const [mouseX, mouseY] = d3.pointer(event, document.body);

        tooltip.html(`
          <div class="tooltip-header">${date}</div>
          <div style="margin-top: 8px;">
            <strong>Languages written:</strong>
          </div>
          ${languagesWithData.map(([language, langData]) => `
            <div style="margin: 4px 0; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <div style="color: white; font-weight: 600;">${language}</div>
              <div style="font-size: 11px; margin-top: 2px;">
                ${langData.changes.toLocaleString()} changes
                ${langData.repositories.length > 0 ? `â€¢ ${langData.repositories.length} repo${langData.repositories.length !== 1 ? 's' : ''}` : ''}
              </div>
              ${langData.repositories.slice(0, 3).map(repo => `
                <div style="font-size: 10px; color: #ccc; margin-left: 8px;">
                  ${repo.name}: ${repo.changes.toLocaleString()}
                </div>
              `).join('')}
              ${langData.repositories.length > 3 ? `<div style="font-size: 10px; color: #ccc; margin-left: 8px;">... and ${langData.repositories.length - 3} more</div>` : ''}
            </div>
          `).join('')}
        `)
        .style("left", (mouseX + 10) + "px")
        .style("top", (mouseY - 10) + "px")
        .classed("visible", true);
      }

      // Draw areas with hover events
      g.selectAll(".area")
        .data(stackedData)
        .enter().append("path")
        .attr("class", "area")
        .attr("d", area)
        .attr("fill", d => getLanguageColor(d.key))
        .attr("opacity", 0.7)
        .on("mouseover", function(event, d) {
          showLanguageTooltip(event, d, d.key);
        })
        .on("mouseout", function() {
          tooltip.classed("visible", false);
        });

      // Add data points (circles) for better visibility
      g.selectAll(".point-group")
        .data(data)
        .enter().append("g")
        .attr("class", "point-group")
        .attr("transform", d => `translate(${xScale(d.date)}, 0)`)
        .on("mouseover", function(event, d) {
          showAllLanguagesTooltip(event, d);
        })
        .on("mouseout", function() {
          tooltip.classed("visible", false);
        });

      // Add circles for each language at each data point
      languages.forEach(language => {
        g.selectAll(`.points-${language.replace(/[^a-zA-Z0-9]/g, '')}`)
          .data(data.filter(d => d[language] > 0))
          .enter().append("circle")
          .attr("class", `points-${language.replace(/[^a-zA-Z0-9]/g, '')}`)
          .attr("cx", d => xScale(d.date))
          .attr("cy", d => {
            // Calculate the y position for this language in the stack
            let yPos = 0;
            for (const lang of languages) {
              if (lang === language) break;
              yPos += d[lang] || 0;
            }
            yPos += (d[language] || 0) / 2; // Center of this language's area
            return yScale(yPos);
          })
          .attr("r", 4)
          .attr("fill", getLanguageColor(language))
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .style("cursor", "pointer")
          .style("pointer-events", "none"); // Let events pass through to point-group
      });

      // Add axes
      g.append("g")
        .attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%m/%d")));

      g.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(yScale).tickFormat(d => d.toLocaleString()));

      // Add grid lines
      g.append("g")
        .attr("class", "grid")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(""));

      g.append("g")
        .attr("class", "grid")
        .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(""));

      // Update legend
      updateLegend(languages);
    }

    function updateLegend(languages) {
      const legendContainer = d3.select("#languageLegend");
      legendContainer.selectAll("*").remove();

      const legendItems = legendContainer.selectAll(".legend-item")
        .data(languages)
        .enter().append("div")
        .attr("class", "legend-item")
        .on("click", function(event, language) {
          // Toggle language visibility (could implement this feature)
          console.log("Clicked language:", language);
        });

      legendItems.append("div")
        .attr("class", "legend-color")
        .style("background-color", d => getLanguageColor(d));

      legendItems.append("span")
        .text(d => d);
    }

    function showLoading(show) {
      document.getElementById("loading").style.display = show ? 'block' : 'none';
      document.getElementById("analyzeButton").disabled = show;
    }

    function showError(message) {
      const errorDiv = document.getElementById("error");
      errorDiv.textContent = message;
      errorDiv.classList.remove("hidden");
    }

    function hideError() {
      document.getElementById("error").classList.add("hidden");
    }

    function showResults() {
      document.getElementById("results").classList.remove("hidden");
    }

    function hideResults() {
      document.getElementById("results").classList.add("hidden");
    }


    // Client-side aggregation functions
    function aggregateCommitsByTimeAndLanguage(commits, timePeriod) {
      const aggregated = {};

      commits.forEach(commit => {
        const date = new Date(commit.committedDate);
        const timeKey = getTimeKey(date, timePeriod);
        const repoName = `${commit.repository.owner}/${commit.repository.name}`;

        if (!aggregated[timeKey]) {
          aggregated[timeKey] = {
            date: timeKey,
            languages: {},
            totalCommits: 0,
            totalAdditions: 0,
            totalDeletions: 0,
            totalChanges: 0
          };
        }

        aggregated[timeKey].totalCommits++;

        commit.files.forEach(file => {
          const language = file.language;

          if (!aggregated[timeKey].languages[language]) {
            aggregated[timeKey].languages[language] = {
              additions: 0,
              deletions: 0,
              changes: 0,
              files: 0,
              repositories: new Map()
            };
          }

          const langData = aggregated[timeKey].languages[language];
          langData.additions += file.additions;
          langData.deletions += file.deletions;
          langData.changes += file.changes;
          langData.files++;

          // Track repository contributions for this language
          if (!langData.repositories.has(repoName)) {
            langData.repositories.set(repoName, {
              name: repoName,
              additions: 0,
              deletions: 0,
              changes: 0,
              files: 0,
              commits: new Set()
            });
          }

          const repoData = langData.repositories.get(repoName);
          repoData.additions += file.additions;
          repoData.deletions += file.deletions;
          repoData.changes += file.changes;
          repoData.files++;
          repoData.commits.add(commit.oid);

          aggregated[timeKey].totalAdditions += file.additions;
          aggregated[timeKey].totalDeletions += file.deletions;
          aggregated[timeKey].totalChanges += file.changes;
        });
      });

      // Convert repository Maps to arrays and commit Sets to counts
      Object.values(aggregated).forEach(timeData => {
        Object.values(timeData.languages).forEach(langData => {
          langData.repositories = Array.from(langData.repositories.values()).map(repo => ({
            ...repo,
            commits: repo.commits.size
          })).sort((a, b) => b.changes - a.changes);
        });
      });

      return Object.values(aggregated).sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function getTimeKey(date, timePeriod) {
      if (timePeriod === 'weekly') {
        const startOfWeek = new Date(date);
        // Set to Sunday (start of week) by subtracting the day of week
        const dayOfWeek = startOfWeek.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const diffToSunday = dayOfWeek;

        // Use setTime instead of setDate to avoid month boundary issues
        startOfWeek.setTime(startOfWeek.getTime() - (diffToSunday * 24 * 60 * 60 * 1000));

        // Reset to start of day to ensure consistency
        startOfWeek.setHours(0, 0, 0, 0);

        return startOfWeek.toISOString().split('T')[0];
      } else {
        return date.toISOString().split('T')[0];
      }
    }

    function calculateSummaryStats(commits) {
      const languageStats = {};
      let totalAdditions = 0;
      let totalDeletions = 0;
      let totalFiles = 0;

      commits.forEach(commit => {
        commit.files.forEach(file => {
          const language = file.language;

          if (!languageStats[language]) {
            languageStats[language] = {
              additions: 0,
              deletions: 0,
              changes: 0,
              files: 0,
              commits: new Set()
            };
          }

          languageStats[language].additions += file.additions;
          languageStats[language].deletions += file.deletions;
          languageStats[language].changes += file.changes;
          languageStats[language].files++;
          languageStats[language].commits.add(commit.oid);

          totalAdditions += file.additions;
          totalDeletions += file.deletions;
          totalFiles++;
        });
      });

      // Convert Sets to counts
      Object.keys(languageStats).forEach(language => {
        languageStats[language].commits = languageStats[language].commits.size;
      });

      // Sort languages by total changes
      const sortedLanguages = Object.entries(languageStats)
        .sort(([,a], [,b]) => b.changes - a.changes)
        .map(([language, stats]) => ({ language, ...stats }));

      return {
        totalAdditions,
        totalDeletions,
        totalChanges: totalAdditions + totalDeletions,
        totalFiles,
        totalCommits: commits.length,
        languageBreakdown: sortedLanguages,
        topLanguages: sortedLanguages.slice(0, 10)
      };
    }

    function populateCommitList() {
      const container = document.getElementById("commitList");

      // Sort commits by total changes (descending) to show largest first
      const sortedCommits = [...rawCommits].sort((a, b) => {
        const aChanges = a.files.reduce((sum, file) => sum + file.changes, 0);
        const bChanges = b.files.reduce((sum, file) => sum + file.changes, 0);
        return bChanges - aChanges;
      });

      container.innerHTML = sortedCommits.map(commit => {
        const totalChanges = commit.files.reduce((sum, file) => sum + file.changes, 0);
        const date = new Date(commit.committedDate).toLocaleDateString();
        const repoName = `${commit.repository.owner}/${commit.repository.name}`;
        const isExcluded = excludedCommits.has(commit.oid);

        return `
          <div class="commit-item ${isExcluded ? 'excluded' : ''}" onclick="toggleCommitExclusion('${commit.oid}')">
            <input type="checkbox" class="commit-checkbox" ${isExcluded ? '' : 'checked'}
                   onchange="event.stopPropagation(); toggleCommitExclusion('${commit.oid}')">
            <div class="commit-details">
              <div class="commit-message">${commit.message.split('\n')[0]}</div>
              <div class="commit-meta">${repoName} â€¢ ${date}</div>
            </div>
            <div class="commit-stats">${totalChanges.toLocaleString()} changes</div>
          </div>
        `;
      }).join('');
    }

    function toggleCommitExclusion(commitId) {
      if (excludedCommits.has(commitId)) {
        excludedCommits.delete(commitId);
      } else {
        excludedCommits.add(commitId);
      }

      // Update displays with new filter
      updateDisplays();
      populateCommitList();
    }

    function populateLanguageFilters(timelineData) {
      // Get all languages from the data
      const allLanguages = new Set();
      timelineData.forEach(d => Object.keys(d.languages).forEach(lang => allLanguages.add(lang)));

      const languageTotals = Array.from(allLanguages).map(lang => ({
        language: lang,
        total: timelineData.reduce((sum, d) => sum + (d.languages[lang]?.changes || 0), 0)
      })).sort((a, b) => b.total - a.total);

      const container = document.getElementById("languageFilters");
      container.innerHTML = languageTotals.map(({ language }) => {
        const isEnabled = !excludedLanguages.has(language);
        return `
          <div class="language-filter-toggle ${isEnabled ? 'enabled' : 'disabled'}"
               onclick="toggleLanguageFilter('${language}')">
            <div class="language-filter-color" style="background-color: ${getLanguageColor(language)};"></div>
            <span>${language}</span>
          </div>
        `;
      }).join('');
    }

    function populateRepositoryFilters() {
      // Get all repositories from the raw commits data
      const allRepositories = new Set();
      rawCommits.forEach(commit => {
        const repoName = `${commit.repository.owner}/${commit.repository.name}`;
        allRepositories.add(repoName);
      });

      // Calculate commit counts for each repository
      const repositoryStats = Array.from(allRepositories).map(repoName => {
        const commits = rawCommits.filter(commit =>
          `${commit.repository.owner}/${commit.repository.name}` === repoName
        );
        return {
          name: repoName,
          commitCount: commits.length,
          totalChanges: commits.reduce((sum, commit) =>
            sum + commit.files.reduce((fileSum, file) => fileSum + file.changes, 0), 0
          )
        };
      }).sort((a, b) => b.totalChanges - a.totalChanges);

      const container = document.getElementById("repositoryFilters");
      container.innerHTML = repositoryStats.map(({ name, commitCount, totalChanges }) => {
        const isEnabled = !excludedRepositories.has(name);
        const shortName = name.split('/')[1]; // Just show repo name, not owner/repo
        return `
          <div class="repository-filter-toggle ${isEnabled ? 'enabled' : 'disabled'}"
               onclick="toggleRepositoryFilter('${name}')"
               title="${name} â€¢ ${commitCount} commits â€¢ ${totalChanges.toLocaleString()} changes">
            <div class="repository-filter-icon"></div>
            <span>${shortName}</span>
          </div>
        `;
      }).join('');
    }

    function toggleRepositoryFilter(repoName) {
      if (excludedRepositories.has(repoName)) {
        excludedRepositories.delete(repoName);
      } else {
        excludedRepositories.add(repoName);
      }

      // Update displays with new filter
      updateDisplays();
    }

    function toggleLanguageFilter(language) {
      if (excludedLanguages.has(language)) {
        excludedLanguages.delete(language);
      } else {
        excludedLanguages.add(language);
      }

      // Update displays with new filter
      updateDisplays();
    }

    function toggleFilters() {
      const content = document.getElementById("filterContent");
      const button = document.getElementById("filterToggleBtn");

      if (content.classList.contains("expanded")) {
        content.classList.remove("expanded");
        button.textContent = "Show";
      } else {
        content.classList.add("expanded");
        button.textContent = "Hide";
      }
    }

    handleAuthCode();
  </script>
</body>
</html>
